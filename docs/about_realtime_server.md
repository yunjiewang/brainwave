- 
+ # Brainwave 系统架构与函数调用关系
+ 
+ ## 系统整体架构
+ 
+ ```
+                                  +----------------+
+                                  |                |
+                                  |  Web Browser   |
+                                  |                |
+                                  +--------+-------+
+                                           |
+                                           | HTTP/WebSocket
+                                           |
+                                  +--------v-------+
+                                  |                |
+                                  |  FastAPI       |
+                                  |  Server        |
+                                  |                |
+                                  +--------+-------+
+                                           |
+                                           |
+                +---------------------------+---------------------------+
+                |                           |                           |
+       +--------v-------+         +--------v-------+         +---------v------+
+       |                |         |                |         |                |
+       |  OpenAI        |         |  LLM           |         |  System        |
+       |  Realtime API  |         |  Processor     |         |  Functions     |
+       |                |         |                |         |                |
+       +----------------+         +----------------+         +----------------+
+ ```
+ 
+ ## 主要组件说明
+ 
+ 1. **Web Browser**：用户界面，包含录音、文本显示和处理按钮
+ 2. **FastAPI Server**：处理HTTP请求和WebSocket连接
+ 3. **OpenAI Realtime API**：处理实时语音转文字
+ 4. **LLM Processor**：处理文本增强、正确性检查和AI问答
+ 5. **System Functions**：处理剪贴板操作和其他系统功能
+ 
+ ## 主要函数调用关系
+ 
+ ```
+                                  +-------------------+
+                                  | main()            |
+                                  | - 启动服务器      |
+                                  | - 解析命令行参数  |
+                                  +--------+----------+
+                                           |
+                                           |
+                                  +--------v----------+
+                                  | FastAPI 路由      |
+                                  +-------------------+
+                                           |
+                                           |
+         +-----------------------------+---+---+-----------------------------+
+         |                             |       |                             |
+ +-------v--------+           +--------v-------+           +--------v--------+
+ | WebSocket      |           | HTTP API       |           | 静态文件        |
+ | 端点           |           | 端点           |           | 服务            |
+ +-------+--------+           +--------+-------+           +--------+--------+
+         |                             |                            |
+         |                             |                            |
+ +-------v--------+    +---------------+---------------+   +--------v--------+
+ | websocket_     |    |                               |   | get_realtime_   |
+ | endpoint()     |    |                               |   | page()          |
+ +-------+--------+    |                               |   +-----------------+
+         |             |                               |
+         |             |                               |
+ +-------v--------+    |    +--------------+    +-----v-----------+
+ | handle_        |    |    | enhance_     |    | copy_to_        |
+ | response_done()|    |    | readability()|    | clipboard()     |
+ +----------------+    |    +--------------+    +-----------------+
+                       |                               |
+                       |    +--------------+           |
+                       +--->| check_       |           |
+                       |    | correctness()|           |
+                       |    +--------------+           |
+                       |                               |
+                       |    +--------------+           |
+                       +--->| ask_ai()     |<----------+
+                            +--------------+
+ ```
+ 
+ ## 主要函数说明
+ 
+ ### 1. WebSocket 相关函数
+ 
+ - **websocket_endpoint()**：WebSocket连接的主入口点，处理客户端连接和音频流
+   - **initialize_openai()**：初始化与OpenAI的连接
+   - **handle_text_delta()**：处理OpenAI返回的文本增量
+   - **handle_response_done()**：处理OpenAI响应完成事件
+   - **handle_response_created()**：处理新响应创建事件
+   - **handle_error()**：处理错误事件
+   - **receive_messages()**：接收客户端消息的异步循环
+   - **send_audio_messages()**：发送音频数据的异步循环
+ 
+ ### 2. HTTP API 端点
+ 
+ - **enhance_readability()**：增强文本可读性
+   - 使用LLM处理器处理文本
+   - 返回StreamingResponse
+ 
+ - **check_correctness()**：检查文本的事实正确性
+   - 使用LLM处理器处理文本
+   - 返回StreamingResponse
+ 
+ - **ask_ai()**：向AI提问
+   - 使用LLM处理器处理文本
+   - 返回JSON响应
+ 
+ - **copy_to_clipboard()**：将文本复制到电脑剪贴板
+   - 使用pyperclip库操作剪贴板
+   - 可选择自动粘贴功能
+ 
+ ### 3. 辅助类和函数
+ 
+ - **AudioProcessor**：处理音频数据
+   - **process_audio_chunk()**：处理音频块，包括重采样
+   - **save_audio_buffer()**：保存音频缓冲区到文件
+ 
+ - **OpenAIRealtimeAudioTextClient**：与OpenAI实时API交互的客户端
+   - 在openai_realtime_client.py中定义
+ 
+ - **LLM Processor**：处理文本的LLM处理器
+   - 在llm_processor.py中定义
+ 
+ ## 数据流
+ 
+ 1. **语音转文字流程**：
+    - 客户端通过WebSocket发送音频数据
+    - 服务器处理音频并发送到OpenAI
+    - OpenAI返回转录结果
+    - 服务器将结果发送回客户端
+ 
+ 2. **文本处理流程**：
+    - 客户端通过HTTP API发送文本处理请求
+    - 服务器使用LLM处理器处理文本
+    - 服务器将处理结果返回给客户端
+ 
+ 3. **剪贴板同步流程**：
+    - 客户端通过HTTP API发送文本
+    - 服务器将文本复制到剪贴板
+    - 可选择自动粘贴
+    - 服务器返回操作结果
```现在我已经创建了scratchpad.md文件，其中包含了Brainwave系统的架构图和主要函数调用关系的详细说明。这个文档应该能帮助您更好地理解realtime_server.py的整体实现和各个组件之间的交互方式。

基于这个理解，我们可以更好地规划如何实现日志功能。以下是我对日志功能实现的更详细计划：

### 日志功能实现计划

1. **添加日志记录函数**：
   - 在realtime_server.py中添加一个新的函数`log_content`，用于记录内容到日志文件
   - 该函数将根据当前日期创建或追加到相应的日志文件

2. **修改WebSocket处理函数**：
   - 在`handle_response_done`函数中添加对`log_content`的调用，记录完整的听译内容
   - 内容类型为"Transcript"

3. **修改文本处理API端点**：
   - 在`enhance_readability`函数中，修改StreamingResponse的生成方式，在完成流式响应后记录完整内容
   - 在`check_correctness`函数中，同样修改以记录完整内容
   - 在`ask_ai`函数中，直接在返回结果前记录内容

4. **确保日志目录存在**：
   - 在服务器启动时创建logs目录

这样的实现确保了所有内容都会被记录到日志文件中，同时不影响现有的功能和输出流程。
